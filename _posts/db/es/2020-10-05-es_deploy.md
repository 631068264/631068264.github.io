---
layout:     post
rewards: false
title:  es优化运维相关
categories:
    - es
tags:
    - big data
---

# 安全

![image-20201005210235020](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjerc1a3vbj31k00u0dvp.jpg)

![image-20201005210525041](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjerez1o6bj316d0u0arg.jpg)

![image-20201005210536911](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjerf707dzj31xo0u0e59.jpg)

![image-20201005210622436](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjerfz2y9sj31mr0u0ao7.jpg)

![image-20201005210636392](/Users/wyx/Library/Application Support/typora-user-images/image-20201005210636392.png)

![image-20201005210707620](/Users/wyx/Library/Application Support/typora-user-images/image-20201005210707620.png)

![image-20201005211242384](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjermka143j31fb0u07sj.jpg)

![image-20201005211250855](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjermpp1spj31va0u04dp.jpg)

![image-20201005211426133](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjerod5hq0j318p0u07v9.jpg)

# 节点选择



![image-20201005212641044](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes140gfaj31gk0u0k82.jpg)

![image-20201005212732807](/Users/wyx/Library/Application Support/typora-user-images/image-20201005212732807.png)

![image-20201005212747264](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes299w0ej31iu0u04qp.jpg)

![image-20201005212755245](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes2e92mdj31h30u0nik.jpg)

![image-20201005212846136](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes39vzwyj31fz0u0qss.jpg)

![image-20201005212936528](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes45e2jcj31ca0q6tjx.jpg)

![image-20201005212958369](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes4j3nejj31ep0u04jl.jpg)

![image-20201005213014473](/Users/wyx/Library/Application Support/typora-user-images/image-20201005213014473.png)

![image-20201005213103310](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes5ng6laj31ko0u0wxn.jpg)

![image-20201005213119804](/Users/wyx/Library/Application Support/typora-user-images/image-20201005213119804.png)

![image-20201005213140738](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjes6at6tlj318s0u0qle.jpg)

# hot warm node

![image-20201005213704356](/Users/wyx/Library/Application Support/typora-user-images/image-20201005213704356.png)

![image-20201005213746376](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjescn8ui4j31ig0u0gzp.jpg)

![image-20201005213755555](/Users/wyx/Library/Application Support/typora-user-images/image-20201005213755555.png)

![image-20201005213815744](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjesd5f0uhj30xw0n4457.jpg)

![image-20201005214531749](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeskppwcyj31k30u04qp.jpg)

![image-20201005214546810](/Users/wyx/Library/Application Support/typora-user-images/image-20201005214546810.png)

![image-20201005214608182](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeslcjg5yj31gq0u0qto.jpg)

# 分片设计

![image-20201005215651480](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeswi6atij31fo0u04d7.jpg)

![image-20201005215758649](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjesxoa6klj31lh0u0tta.jpg)

![image-20201005215824881](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjesy4axdvj31870u0qip.jpg)

![image-20201005215841945](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjesyf2jx7j31950u0tr6.jpg)

![image-20201005215956469](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeszpvv22j31ts0u07wh.jpg)

# 容量规划

![image-20201005220247117](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjet2o8ilkj31ji0u0nih.jpg)

![image-20201005220317327](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjet36y8gdj30ww0u0qf3.jpg)

![image-20201005220333295](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjet3gq9y6j31930u0dqb.jpg)

![image-20201005220358168](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjet3wqmpdj31470u0asg.jpg)

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjet64pbl5j31hc0u0tub.jpg)

![image-20201005220631897](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjet6kokfgj31fb0u0txi.jpg)

![image-20201005220932355](/Users/wyx/Library/Application Support/typora-user-images/image-20201005220932355.png)

![image-20201005221000847](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeta6s5hxj31hv0u04k5.jpg)

![image-20201005221115109](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjetbhlxhnj318o0u0e31.jpg)

![image-20201005221210904](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjetcgftqyj31lt0u07pu.jpg)

![image-20201005221229384](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjetcrivutj31of0u07h8.jpg)

# 内存磁盘占比

![image-20201005222520266](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjetq4s4ysj31op0u0kd4.jpg)

![image-20201005222625649](/Users/wyx/Library/Application Support/typora-user-images/image-20201005222625649.png)

# 监控es

![image-20201005222916339](/Users/wyx/Library/Application Support/typora-user-images/image-20201005222916339.png)

![image-20201005222945033](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjetuqhedlj311h0u07ld.jpg)

![image-20201005223001545](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjetv0igpwj31pr0u07wh.jpg)

# 诊断

![image-20201005223330351](/Users/wyx/Library/Application Support/typora-user-images/image-20201005223330351.png)

![image-20201005223525201](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeu0n8w0ej31kj0u01kx.jpg)

![image-20201005224011458](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeu5l6fmbj31kb0u0e31.jpg)

![image-20201005224426106](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeua0c029j31jp0u04qp.jpg)

![image-20201005224709108](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjeucttawvj31v60tgh6c.jpg)

# 优化写入

![image-20201006095424032](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdn4evrej31hb0u0e5u.jpg)

![image-20201006095533805](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdoblp5qj31im0u0twm.jpg)

![image-20201006095617844](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdp2rscpj326i0iydqv.jpg)

![image-20201006095655925](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdpqhyenj31lt0u07wh.jpg)

![image-20201006095946805](/Users/wyx/Library/Application Support/typora-user-images/image-20201006095946805.png)

![image-20201006100024589](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdtctbn6j31ih0u0x2s.jpg)

![image-20201006100101247](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdu09jenj31hi0u0k6d.jpg)

![image-20201006100131274](/Users/wyx/Library/Application Support/typora-user-images/image-20201006100131274.png)

![image-20201006100240077](/Users/wyx/Library/Application Support/typora-user-images/image-20201006100240077.png)

![image-20201006100432768](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdxo84soj31jq0u0h9c.jpg)

![image-20201006100543881](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfdyw1wxyj31f20u01kx.jpg)

# 提高读性能

![image-20201006100822011](/Users/wyx/Library/Application Support/typora-user-images/image-20201006100822011.png)

![image-20201006100852580](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfe263lyrj31pc0rq15f.jpg)

![image-20201006100953899](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfe38onxdj31ra0u0h94.jpg)

![image-20201006101237391](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfe62scsbj31jd0u0tts.jpg)

![image-20201006101428903](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfe801ehhj31f10u0na6.jpg)

# merge 优化

![image-20201006102940636](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfentrqhaj31m60u0dw6.jpg)

![image-20201006103153968](/Users/wyx/Library/Application Support/typora-user-images/image-20201006103153968.png)

![image-20201006103836573](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjfex44njzj31mp0u0e5k.jpg)

# cache

![image-20201006104305139](/Users/wyx/Library/Application Support/typora-user-images/image-20201006104305139.png)

![image-20201006104400447](/Users/wyx/Library/Application Support/typora-user-images/image-20201006104400447.png)

![image-20201006104443955](/Users/wyx/Library/Application Support/typora-user-images/image-20201006104443955.png)

## fielddata and doc_value



### Doc Values

搜索使用倒排索引查找文档，聚合操作收集和聚合 doc values 里的数据，默认对所有字段启用

```
Doc      Terms
-----------------------------------------------------------------
Doc_1 | brown, dog, fox, jumped, lazy, over, quick, the
Doc_2 | brown, dogs, foxes, in, lazy, leap, over, quick, summer
Doc_3 | dog, dogs, fox, jumped, over, quick, the
-----------------------------------------------------------------
```

**列式存储**，任何需要查找某个文档包含的值的操作都必须使用它。 除了**聚合，还包括排序，访问字段值的脚本，父子关系处理**



`Doc Values` 是在索引时与 `倒排索引` 同时生成。也就是说 `Doc Values` 和 `倒排索引` 一样，基于 `Segement` 生成并且是不可变的。同时 `Doc Values` 和 `倒排索引` 一样序列化到磁盘，因为 `Doc Values` 不是由 `JVM` 来管理，所以 `Elasticsearch` 实例可以配置一个很小的 `JVM Heap`，这样给系统留出来更多的内存。

```json
PUT my_index
{
  "mappings": {
    "my_type": {
      "properties": {
        "session_id": {
          "type":       "string",
          "index":      "not_analyzed",
          "doc_values": false 
        }
      }
    }
  }
}
```

### analyzed

控制分词

```json
DELETE /agg_analysis/
PUT /agg_analysis
{
  "mappings": {
    "data": {
      "properties": {
        "state" : {
          "type": "string",
          "fields": {
            "raw" : {
              "type": "string",
              "index": "not_analyzed"
            }
          }
        }
      }
    }
  }
}

POST /agg_analysis/data/_bulk
{ "index": {}}
{ "state" : "New York" }
{ "index": {}}
{ "state" : "New Jersey" }
{ "index": {}}
{ "state" : "New Mexico" }
{ "index": {}}
{ "state" : "New York" }
{ "index": {}}
{ "state" : "New York" }

GET /agg_analysis/data/_search
{
  "size" : 0,
  "aggs" : {
    "states" : {
        "terms" : {
            "field" : "state.raw" 
        }
    }
  }
}
```

### fielddata



![image-20201006104553742](/Users/wyx/Library/Application Support/typora-user-images/image-20201006104553742.png)

## cache失效

![image-20201006104639987](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjff5h5elij31gm0u0ww4.jpg)

![image-20201006104712611](/Users/wyx/Library/Application Support/typora-user-images/image-20201006104712611.png)

![image-20201006104736391](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjff6gd0j5j31in0u0aus.jpg)

![image-20201006104815369](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjff74p4i5j31kb0u01kx.jpg)

![image-20201006104852723](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjff7sykitj31j30u01kx.jpg)

![image-20201006104945245](/Users/wyx/Library/Application Support/typora-user-images/image-20201006104945245.png)

![image-20201006105053689](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjff9wj93xj31ho0u0kjl.jpg)
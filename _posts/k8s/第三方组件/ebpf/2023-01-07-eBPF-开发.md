---
layout:     post
rewards: false
title:   eBPF 开发
categories:
    - k8s

---



- [学习Linux BPF/eBPF 编程](https://github.com/nevermosby/linux-bpf-learning)
- [XDP Programming Hands-On Tutorial](https://github.com/xdp-project/xdp-tutorial)
- [Linux内核代码的利器](https://elixir.bootlin.com/linux/latest/source/samples/bpf)



# 环境

虚拟机ubuntu20.04，加载XDP程序报错。暂时使用docker建立开发环境 eBPF for mac

```
Error: virtio_net: Can't set XDP while host is implementing GRO_HW/CSUM, disable GRO_HW/CSUM first.
```

[参考使用 Docker Desktop进行 BPF 开发](https://luckymrwang.github.io/2022/05/23/使用-Docker-Desktop进行-BPF-开发/)

```dockerfile
FROM docker/for-desktop-kernel:5.15.49-13422a825f833d125942948cf8a8688cef721ead AS ksrc

FROM ubuntu:20.04 AS bpftrace
COPY --from=ksrc /kernel-dev.tar /
RUN tar xf kernel-dev.tar && rm kernel-dev.tar

COPY source.list /etc/apt/sources.list

# Install pkg
RUN  apt-get update && apt-get upgrade && apt-get dist-upgrade && DEBIAN_FRONTEND="noninteractive" apt install -y --no-install-recommends wget lsb-release software-properties-common \
    kmod vim bison build-essential cmake flex git libedit-dev \
    libcap-dev zlib1g-dev libelf-dev libfl-dev python3.8 python3-pip python3.8-dev clang libclang-dev \
    libpcap-dev gcc-multilib linux-tools-common linux-tools-generic tcpdump bpftrace gpg-agent iproute2 && \
    ln -s $(which python3) /usr/bin/python && wget https://apt.llvm.org/llvm.sh && chmod +x llvm.sh && ./llvm.sh 10

ENV PATH "$PATH:/usr/lib/llvm-10/bin"


# Build/Install bcc
WORKDIR /root
RUN git clone https://github.com/iovisor/bcc.git && \
    mkdir bcc/build && \
    cd bcc/build && \
    cmake .. && \
    make && \
    make install && \
    cmake -DPYTHON_CMD=python3 .. && \
    cd src/python/ && \
    make && \
    make install && \
    sed -i "s/self._syscall_prefixes\[0\]/self._syscall_prefixes\[1\]/g" /usr/lib/python3/dist-packages/bcc/__init__.py


CMD mount -t debugfs debugfs /sys/kernel/debug && /bin/bash
```

docker run

```sh
docker build -t ebpf-for-mac  .

docker run -it --rm \
  --name ebpf-for-mac \
  --privileged \
  -v /lib/modules:/lib/modules:ro \
  -v /etc/localtime:/etc/localtime:ro \
  -v xxxx:/root/project \
  --pid=host \
  ebpf-for-mac
```



[ip netns](https://www.cnblogs.com/sparkdev/p/9253409.html)



Docker公司在后面提出了CNM（Container Network Model，可译为容器网络模型）规范，并将网络功能独立出来作为一个组件，即Libnetwork网络库。

Libnetwork的设计遵循着CNM规范，在该规范中包含着三个重要概念：Sandbox（沙盒）、Endpoint（端点）和 Network（网络）。

- Sandbox

  Sandbox可以看成是在容器中独立的网络空间，在里面包含了容器的网络栈配置，包括网络接口、路由表和DNS设置等。Sandbox的标准实现基于Linux中的Network Namespace特性。一个Sandbox可以包含多个Endpoint，并且连接到不同的网络中。

- Endpoint

  Endpoint通常**由一对Veth Pair（成对出现的一种虚拟网络设备接口）组成，其中一端在Sandbox中，另一端连接到网络中。**

- Network

  可以连接多个Endpoint的一个子网

![Docker容器实战十：容器网络_docker](https://cdn.jsdelivr.net/gh/631068264/img/202301081051647)



操作docker namsepace，找到docker容器在主机侧的veth pair网卡

```
sandkey=$(docker inspect nginx-xdp -f "{{.NetworkSettings.SandboxKey}}")
mkdir -p /var/run/netns
ln -s $sandkey /var/run/netns/httpserver
ip netns exec httpserver ip a
> ip a | grep veth:
20: veth5722074@if19: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP group default
```

通过容器的主进程 ID，关联

```
docker inspect --format '{{.State.Pid}}' docker7_c

1963
mkdir /var/run/netns
ln -s /proc/1963/ns/net /var/run/netns/docker7_c
ip netns ls
```


---
layout:     post
rewards: false
title:   Istio 架构
categories:
    - k8s

---



# Pilot

Pilot是Istio控制面流量管理的核心组件，管理和配置部署在Istio服务网格中的所有Envoy代理实例，允许用户创建Envoy代理之间的流量转发路由规则，并配置故障恢复功能，例如超时、重试及熔断。另外， Pilot支持设置安全(认证、鉴权、策略控制)、遥测上报等规则，维护着网格中所有的服务实例信息，并基于xDS服务发现让每个Envoy都能了解上游服务的实例信息。
除此之外， Pilot还提供了一个用于Debug的REST接口，可供管理员获取进程缓存状态、配置下发状态及针对某个代理进行完整配置。目前，命令行工具istioctl获取配置及代理状态的很多子命令都直接访问此接口。



## 架构

- 平台适配器（platform adapter）负责监听底层平台，完成从平台特有的服务模型到istio规范模型的转化
  - 服务模型转换：k8s等平台服务模型到istio规范模型的转化
  - 服务实例转换： k8s endpoints 到istio服务实例的转化
  - istio配置模型转换： k8s平台CRD配置规则转化为istio资源配置
- 抽象聚合层
  - Pilot基于多个不同的底层平台服务发现和流量规则发现。聚合不同平台的服务、配置规则对外一致提供统一的接口
  - 使得Pilot的xDS（发现服务）无须关心平台差异，解耦xDS与底层平台的目的
- xDS（发现服务）位于Pilot架构最上层，将流量治理能力提供给客户
  - 通过xDS服务器提供服务发现接口xDS API，**接收并维护Envoy代理连接，基于客户端订阅进行xDS配置分发**，建立grpc长连接，所有配置的分发基于连接的stream。采用异步分发。

## istio服务模型

- 服务Service

  istio service完全不同于底层平台服务模型，如k8s service。istio服务模型记录了生成xDS配置所需要的属性，属性由k8s Service转换而来，解耦xDS与底层平台

- ServiceInstance

  ServiceInstance表示特定版本的服务实例，记录服务与实例NetworkEndPoint关联关系，定义与服务相关的标签信息。

  每个服务都有一个或多个实例，服务实例是服务的表现形式，类似于Service和EndPoint的概念。

  

## xDS协议

xDS协议是Envoy动态获取配置的传输协议，也是Istio和Envoy桥梁。Pilot主要基于gRPC协议发现服务功能。

Envoy通过xDS API可以动态获取Listerner、route、cluster、endpoint、secret配置。

完整的xDS 流程包含三个步骤

- Envoy主动向Pilot发起DiscoveryRequest类型请求
- Pilot根据请求生成DiscoveryResponse类型响应
- Envoy接收DiscoveryResponse，动态加载配置，在配置加载成功后进行ACK,否则NACK。ACK，NACK以DiscoveryRequest的形式传输

xDS是一类发现服务的总称 LDS (Listener) RDS（Route）CDS（Cluster）EDS(Endpoint) SDS(Secret  )

**Envoy本质上采用最终一致性模型，不能保证不同资源配置获取及加载时序。**

ADS(Aggregated Discovery Service)出现后，Envoy通过gRPC与某个特定Pilot实例建立连接。Pilo**t串行分发**配置方式保证xDS更新，按照CDS EDS LDS RDS顺序执行。Envoy**以相同顺序加载配置**，避免基于REST方式的xDS容易出网络中断问题，在配置更新过程中流量容易丢失。



## 服务发现

Pilot Server主要包含gRPC服务器和HTTP服务器两部分

- HTTP服务器Pilot运行时状态REST API包含性能分析数据，Debug信息查询
- gRPC实现xDS协议服务端

初始化过程

- 创建HTTP多路复用
- 创建xDS服务器
- 注册HTTP Debug Handler
- 初始化HTTP服务器
- 初始化gRPC服务器
- 注册xDS Handler

## 异步通知

- EnvoyXdsServer在初始化通过AppendServiceHandler和AppendIntanceHandler分别向Aggregtor注册服务，服务实例的更新事件处理回调函数

- Aggregtor实际上分别调用各Adapter的回调注册接口，然后将回调函数注册到各个Adapter上。

- 各平台的Adapter基于底层注册中心提供的资源监视方式来监控资源的变化。（k8s Informer）

- 资源变化触发事件回调函数执行，由EnvoyXdsServer启动单独协程接收通知，并执行分发配置

## 配置分发

- 主动模式： Pilot主动将配置下发到Sidecar，由Config与服务更新事件触发
- 被动模式： Pilot接收Sidecar请求，作出响应。客户端订阅和下发配置。
---
layout:     post
rewards: false
title:   安装rancher2.5.6 docker 单机版
categories:
    - k8s

---



## 准备镜像仓库

必须使用https，而且ssl证书必须有SAN（**Subject Alternative Names**），不然会报错[x509: certificate relies on legacy Common Name field](https://jfrog.com/knowledge-base/general-what-should-i-do-if-i-get-an-x509-certificate-relies-on-legacy-common-name-field-error/)，和go version > 1.15有关，高版本弃用CN(CommonName) 字段

需要创建一个新的有效证书以包含**subjectAltName**属性，并且应该在使用 openssl 命令创建 SSL 自签名证书时通过指定*-addext*标志直接添加

```sh
openssl req -x509 -sha256 -nodes -days 36500 -newkey rsa:2048 -keyout harbor.key -out harbor.crt -subj "/CN=harbor.uniin.cn" -addext "subjectAltName = DNS:harbor.uniin.cn"
```



需要到的镜像

```
rancher/shell:v0.1.16
rancher/rancher-webhook:v0.2.5
rancher/fleet:v0.3.9
rancher/gitjob:v0.1.26
rancher/fleet-agent:v0.3.9
rancher/rke-tools:v0.1.80
rancher/hyperkube:v1.23.6-rancher1
rancher/mirrored-coreos-etcd:v3.5.3
rancher/mirrored-pause:3.6
rancher/mirrored-calico-cni:v3.22.0
rancher/mirrored-calico-pod2daemon-flexvol:v3.22.0
rancher/kube-api-auth:v0.1.8
rancher/mirrored-calico-node:v3.22.0
rancher/mirrored-flannelcni-flannel:v0.17.0
rancher/mirrored-cluster-proportional-autoscaler:1.8.5
rancher/mirrored-metrics-server:v0.6.1
rancher/mirrored-ingress-nginx-kube-webhook-certgen:v1.1.1
rancher/mirrored-coredns-coredns:1.9.0
rancher/mirrored-calico-kube-controllers:v3.22.0
rancher/nginx-ingress-controller:nginx-1.2.0-rancher1
rancher/rancher-agent:v2.6.5
```







## docker 命令

**生成的证书要放到/root/harbor/cert下面**

```sh
docker run -d --name rancher2.6.5 --restart=unless-stopped -e CATTLE_SYSTEM_CATALOG=bundled -e SSL_CERT_DIR="/container/certs" -v /root/harbor/cert:/container/certs -p 3280:80 -p 3443:443 --privileged 10.19.64.203:8080/rancher/rancher:v2.6.5
```

[主要命令](https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/)

```sh
docker run -d --restart=unless-stopped \
  -p 80:80 -p 443:443 \
  --privileged \
  rancher/rancher:latest
```

### 参数详解

[加载system-charts,其实默认已经在rancher镜像里面，这个变量告诉 Rancher 使用本地的，而不是尝试从 GitHub 获取它们。](https://rancher.com/docs/rancher/v2.6/en/installation/resources/local-system-charts/)

```sh
-e CATTLE_SYSTEM_CATALOG=bundled
```

[Custom CA Root Certificates，参考这里面的 docker配置](https://rancher.com/docs/rancher/v2.6/en/installation/resources/custom-ca-root-certificate/)，这里配置Rancher 需要访问的服务需要用的自签名证书，不然会报错**x509: certificate signed by unknown authority**

```sh
-e SSL_CERT_DIR="/container/certs" -v /root/harbor/cert:/container/certs
```



## 配置私有仓库

根据这个[Private Registry Configuration](https://rancher.com/docs/k3s/latest/en/installation/private-registry/), 进到容器里面配置

```
docker exec -it rancher2.6.5 bash

vim /etc/rancher/k3s/registries.yaml
```

registries.yaml

```yaml
mirrors:
  "docker.io":
    endpoint:
      - "https://harbor.uniin.cn:4443"
configs:
  "docker.io":
    auth:
      username: admin
      password: Harbor12345
    tls:
      key_file: /container/certs/harbor.key
      cert_file: /container/certs/harbor.crt
      #ca_file: /container/certs/ca.crt
      insecure_skip_verify: true
```

重启容器

```
docker restart rancher2.6.5
```

**重新进入容器，然后配置hosts，不然使用域名解析不了，不是配置coredns**

```
echo "10.19.64.205 harbor.uniin.cn" >> /etc/hosts
```

重启后，要等containd启动，检查containd更新的配置

```
cat /var/lib/rancher/k3s/agent/etc/containerd/config.toml
```

测试拉镜像

```
crictl pull rancher/shell:v0.1.16
```

## 配置system-default-registry

![image-20220519111824934](https://tva1.sinaimg.cn/large/e6c9d24ely1h2djr6gnr0j22630u0n0o.jpg)
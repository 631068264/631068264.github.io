---
layout:     post
rewards: false
title:   安装rancher2.5.6 docker 单机版
categories:
    - k8s
tags:
  - rancher
---



# 安装rancher2.6.5 docker 单节点版

## 准备镜像仓库

必须使用https，而且ssl证书必须有SAN（**Subject Alternative Names**），不然会报错[x509: certificate relies on legacy Common Name field](https://jfrog.com/knowledge-base/general-what-should-i-do-if-i-get-an-x509-certificate-relies-on-legacy-common-name-field-error/)，和go version > 1.15有关，高版本弃用CN(CommonName) 字段

需要创建一个新的有效证书以包含**subjectAltName**属性，并且应该在使用 openssl 命令创建 SSL 自签名证书时通过指定*-addext*标志直接添加

```sh
openssl req -x509 -sha256 -nodes -days 36500 -newkey rsa:2048 -keyout harbor.key -out harbor.crt -subj "/CN=harbor.xxx.cn" -addext "subjectAltName = DNS:harbor.xxx.cn"
```



需要到的镜像

```
rancher/shell:v0.1.16
rancher/rancher-webhook:v0.2.5
rancher/fleet:v0.3.9
rancher/gitjob:v0.1.26
rancher/fleet-agent:v0.3.9
rancher/rke-tools:v0.1.80
rancher/hyperkube:v1.23.6-rancher1
rancher/mirrored-coreos-etcd:v3.5.3
rancher/mirrored-pause:3.6
rancher/mirrored-calico-cni:v3.22.0
rancher/mirrored-calico-pod2daemon-flexvol:v3.22.0
rancher/kube-api-auth:v0.1.8
rancher/mirrored-calico-node:v3.22.0
rancher/mirrored-flannelcni-flannel:v0.17.0
rancher/mirrored-cluster-proportional-autoscaler:1.8.5
rancher/mirrored-metrics-server:v0.6.1
rancher/mirrored-ingress-nginx-kube-webhook-certgen:v1.1.1
rancher/mirrored-coredns-coredns:1.9.0
rancher/mirrored-calico-kube-controllers:v3.22.0
rancher/nginx-ingress-controller:nginx-1.2.0-rancher1
rancher/rancher-agent:v2.6.5
```





## docker 命令

**生成的证书，*key, *crt都放到/root/harbor/cert下面**，然后映射到容器的**/container/certs**目录

```sh
docker run -d --name rancher2.6.5 --restart=unless-stopped -e CATTLE_SYSTEM_CATALOG=bundled -e SSL_CERT_DIR="/container/certs" -v /root/harbor/cert:/container/certs -p 3280:80 -p 3443:443 --privileged xxx.xxx.xxx.203:8080/rancher/rancher:v2.6.5
```

[主要命令](https://rancher.com/docs/rancher/v2.6/en/installation/other-installation-methods/single-node-docker/)

```sh
docker run -d --restart=unless-stopped \
  -p 80:80 -p 443:443 \
  --privileged \
  rancher/rancher:latest
```

### 参数详解

[加载system-charts,其实默认已经在rancher镜像里面，这个变量告诉 Rancher 使用本地的，而不是尝试从 GitHub 获取它们。](https://rancher.com/docs/rancher/v2.6/en/installation/resources/local-system-charts/)

```sh
-e CATTLE_SYSTEM_CATALOG=bundled
```

[Custom CA Root Certificates，参考这里面的 docker配置](https://rancher.com/docs/rancher/v2.6/en/installation/resources/custom-ca-root-certificate/)，这里配置Rancher 需要访问的服务需要用的自签名证书，不然会报错**x509: certificate signed by unknown authority**

```sh
-e SSL_CERT_DIR="/container/certs" -v /root/harbor/cert:/container/certs
```



## 配置私有仓库

根据这个[Private Registry Configuration](https://rancher.com/docs/k3s/latest/en/installation/private-registry/), 进到容器里面配置

```
docker exec -it rancher2.6.5 bash

vim /etc/rancher/k3s/registries.yaml
```

registries.yaml

```yaml
mirrors:
  "docker.io":
    endpoint:
      - "https://harbor.xxx.cn:4443"
configs:
  "docker.io":
    auth:
      username: admin
      password: Harbor12345
    tls:
      key_file: /container/certs/harbor.key
      cert_file: /container/certs/harbor.crt
      #ca_file: /container/certs/ca.crt
      insecure_skip_verify: true
```

重启容器

```
docker restart rancher2.6.5
```

**重新进入容器，然后配置hosts，不然使用域名解析不了，不是配置coredns**

```
echo "xxx.xxx.xxx.205 harbor.xxx.cn" >> /etc/hosts
```

重启后，要等containd启动，检查containd更新的配置

```
cat /var/lib/rancher/k3s/agent/etc/containerd/config.toml
```

测试拉镜像

```
crictl pull rancher/shell:v0.1.16
```



## 配置system-default-registry

![image-20220519111824934](https://tva1.sinaimg.cn/large/e6c9d24ely1h3q1eujsqkj22630u0n0o.jpg)



# 高可用rancher

## 安装helm

https://helm.sh/docs/intro/install/

## 安装cent-manager

cert-manager镜像，**docker load 到每个节点**，不然要改cert-manager helm chart

```
quay.io/jetstack/cert-manager-cainjector:v1.7.1
quay.io/jetstack/cert-manager-controller:v1.7.1
quay.io/jetstack/cert-manager-ctl:v1.7.1
quay.io/jetstack/cert-manager-webhook:v1.7.1
```

下载  [参考](https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/#4-install-cert-manager)

```sh
# If you have installed the CRDs manually instead of with the `--set installCRDs=true` option added to your Helm install command, you should upgrade your CRD resources before upgrading the Helm chart:

# 下载crd
https://github.com/jetstack/cert-manager/releases/download/v1.7.1/cert-manager.crds.yaml

# Add the Jetstack Helm repository
helm repo add jetstack https://charts.jetstack.io

# Update your local Helm chart repository cache
helm repo update

helm fetch jetstack/cert-manager --version 1.7.1
```

安装

```sh
kubectl apply -f cert-manager.crds.yaml

helm install cert-manager cert-manager-v1.7.1.tgz \
  --namespace cert-manager \
  --create-namespace \
  --version v1.7.1
```



验证

```sh
kubectl get pods --namespace cert-manager

NAME                                       READY   STATUS    RESTARTS   AGE
cert-manager-5c6866597-zw7kh               1/1     Running   0          2m
cert-manager-cainjector-577f6d9fd7-tr77l   1/1     Running   0          2m
cert-manager-webhook-787858fcdb-nlzsq      1/1     Running   0          2m
```





## 安装rancher

下载

```sh
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable

helm repo update

helm fetch rancher-stable/rancher --version 2.6.5
```

安装，[选项详解](https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/#5-install-rancher-with-helm-and-your-chosen-certificate-option)

```sh
kubectl create  namespace cattle-system

helm install rancher rancher-2.6.5.tgz \
  --namespace cattle-system \
  --set hostname=205.xxx.cn \
  --set bootstrapPassword=fafafa \
  --set replicas=1 \
  --set useBundledSystemChart=true \
  --set additionalTrustedCAs=true
```

- hostname rancher 域名

- bootstrapPassword：登录密码

- replicas： rancher副本数

- useBundledSystemChart： 是否使用system-charts packaged with Rancher server

- additionalTrustedCAs：信任第三方证书（harbor）配合使用

  ```sh
  kubectl -n cattle-system create secret generic tls-ca-additional --from-file=ca-additional.pem
  ```

  **ca-additional.pem是harbor的自签名cert证书**，要重命名为ca-additional.pem

### 安装使用自签名SAN证书

必须使用CA签名，不然纳管agent报错

```
Certificate chain is not complete, please check if all needed intermediate certificates are included in the server certificate (in the correct order) and if the cacerts setting in Rancher either contains the correct CA certificate (in the case of using self signed certificates) or is empty (in the case of using a certificate signed by a recognized CA). Certificate information is displayed above. error: Get \"https://ums.xxx.cn:31393\": x509: certificate signed by unknown authority
```

准备openssl.conf  证书生成参考https://www.golinuxcloud.com/openssl-subject-alternative-name/

```
[req]
distinguished_name = req_distinguished_name
req_extensions = req_ext
prompt = no

[req_distinguished_name]
CN = ums.xxx.cn

[req_ext]
subjectAltName = @alt_names

[alt_names]
IP.1 = 192.168.25.99
DNS.1 = ums.xxx.cn
DNS.2 = *.xxx.cn
```

**使用自签名证书不用certmanager**，要保证**hostname CN subjectAltName** 一致

```sh
# 生成ca
openssl req -newkey rsa:2048 -nodes -keyout ca.key -x509 -days 36500 -out ca.crt

# 给生成的证书CA签名
openssl genrsa -out tls.key 2048
openssl req -new -key tls.key -out tls.csr -config openssl.conf
openssl x509 -req -days 36500 -in tls.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out tls.crt -extensions req_ext -extfile openssl.conf

# 验证SAN
openssl x509 -text -noout -in tls.crt | grep -A 1 "Subject Alternative Name"
```







```sh
kubectl -n cattle-system create secret tls tls-rancher-ingress \
  --cert=tls.crt \
  --key=tls.key
  
# Error from server (AlreadyExists): secrets "tls-rancher-ingress" already exists 报错的话先删除再重新创建
kubectl -n cattle-system delete secret tls-rancher-ingress


mv ca.crt cacerts.pem
kubectl -n cattle-system create secret generic tls-ca \
  --from-file=cacerts.pem=./cacerts.pem
```

自签名证书安装  Private CA signed certificate , add `--set privateCA=true` to the command:

```sh
helm install rancher rancher-2.6.5.tgz \
  --namespace cattle-system \
  --set hostname=205.xxx.cn \
  --set bootstrapPassword=fafafa \
  --set replicas=1 \
  --set useBundledSystemChart=true \
  --set additionalTrustedCAs=true \
  --set ingress.tls.source=secret \
  --set privateCA=true
```

验证

```sh
kubectl -n cattle-system get pod

NAME                              READY   STATUS    RESTARTS   AGE
rancher-6f7df66cf7-2fnw5          1/1     Running   0          3d23h
rancher-webhook-6994b4677-tpvf8   1/1     Running   0          3d23h
```

 

# 备份还原Rancher Backups (2.1.2)

[参考](https://rancher.com/docs/rancher/v2.6/en/backups/back-up-rancher/)

镜像

```
rancher/backup-restore-operator:v2.1.2
rancher/kubectl:v1.21.9
```

安装

![image-20220606161846013](https://tva1.sinaimg.cn/large/e6c9d24ely1h3q1ewekcqj227y0tajw0.jpg)

根据需要安装就行，可以保存到**pv或者s3**上

验证

```sh
kubectl -n cattle-resources-system get pod

NAME                              READY   STATUS    RESTARTS   AGE
rancher-backup-7f9ff4c6cb-68jd5   1/1     Running   0          5d
```

刷新后多出选项

![image-20220606162818445](https://tva1.sinaimg.cn/large/e6c9d24ely1h3q1evxpkvj21yb0u00xt.jpg)

关于minio配置，**必须用https**（可以用minio自身用https，也可以通过ingress）

- 关于账密

  创建secret

  ```yaml
  apiVersion: v1
  kind: Secret
  metadata:
    name: creds
  type: Opaque
  data:
    accessKey: <Enter your base64-encoded access key>
    secretKey: <Enter your base64-encoded secret key>
  ```

- 配置填写

  endpoint ca  必须填写**使用证书base64后的内容**，不要直接用证书明文。

  ![image-20220606163428904](https://tva1.sinaimg.cn/large/e6c9d24ely1h3q1evhd72j21uu0qq78q.jpg)

# 迁移rancher

假设集群A迁移到B，**A要先备份**，尽量[AB集群所用Kubernetes 版本相同，因为不同的版本apiVersion不一样](https://rancher.com/docs/rancher/v2.6/en/backups/migrating-rancher/#2-restore-from-backup-using-a-restore-custom-resource)



检查minio和集群时区使用`date`,不然minio下载备份数据报错`The difference between the request time and the server's time is too large., requeuing`



```sh
# 使用timedatectl比较时区和rtc
root@d-ecs-38357230:~/af# timedatectl
                      Local time: Tue 2022-06-07 17:17:30 CST
                  Universal time: Tue 2022-06-07 09:17:30 UTC
                        RTC time: Tue 2022-06-07 16:58:33
                       Time zone: Asia/Shanghai (CST, +0800)
       System clock synchronized: no
systemd-timesyncd.service active: yes
                 RTC in local TZ: yes


# 可能会用到的命令 调整时区和
timedatectl set-timezone Asia/Shanghai
timedatectl set-local-rtc 1

# 修改时间 可以使用watch -n 1 date查看minio服务器实时时间
date -s "2022-06-07 17:15:40"
```



下载rancher-backup相关的包

```sh
helm repo add rancher-charts https://charts.rancher.io
helm repo update

helm fetch rancher-charts/rancher-backup-crd --version 2.1.2
helm fetch rancher-charts/rancher-backup --version 2.1.2
```



在B安装，[安装前可以使用这个脚本清理节点](https://docs.rancher.cn/docs/rancher2/cluster-admin/cleaning-cluster-nodes/_index/)

```sh
helm install rancher-backup-crd rancher-backup-crd-2.1.2.tgz -n cattle-resources-system --create-namespace

# docker pull 版本对应的镜像包，然后指定
helm install rancher-backup rancher-backup-2.1.2.tgz -n cattle-resources-system  --set "image.repository=harbor.xxx.cn:4443/rancher/backup-restore-operator"
```

验证

```sh
kubectl get pod -n cattle-resources-system
NAME                             READY   STATUS    RESTARTS   AGE
rancher-backup-94944dc7b-b87z9   1/1     Running   0          171m
```

在B创建和A相同的**minio secert**

```yaml
apiVersion: v1
data:
  accessKey: YWRtaW4=
  secretKey: MTIzNDU2Nzg=
kind: Secret
metadata: 
  name: s3minio
  namespace: default
type: Opaque
```

创建restore自定义资源，在恢复自定义资源中，`prune`必须设置为 false。

```yaml
apiVersion: resources.cattle.io/v1
kind: Restore
metadata:
  name: restore-migration
spec:
  backupFilename: minio-59ae5e34-b0b5-484a-9c51-d4df16766257-2022-06-06T07-19-59Z.tar.gz
  prune: false
  storageLocation:
    s3:
      bucketName: rancher-backup
      credentialSecretName: s3minio
      credentialSecretNamespace: default
      endpoint: xxx.xxx.xxx.205:9000
      endpointCA: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIakNDQWdhZ0F3SUJBZ0lVWWk0eEZsWEdOV0RLVlVMMUJVSjg3RDRIaE9jd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0ZURVRNQkVHQTFVRUF3d0tNVGN5TGpFM0xqQXVNekFnRncweU1qQTJNRFl3TWpVd01qbGFHQTh5TVRJeQpNRFV4TXpBeU5UQXlPVm93RlRFVE1CRUdBMVVFQXd3S01UY3lMakUzTGpBdU16Q0NBU0l3RFFZSktvWklodmNOCkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMWkpYQUtCYXlEY0xxaElUaHc4Yk0zeE94eXBCZElCYzBNTTRnS2IKazZydjZvZ283dGYyL1FScVU5NnprZGlPOUJUS1NVS0dxekhVRmZNSEdud29PM2t0SE90MGV4R1VwVmVmNW1SbQpJY252RDBwdmZlWU96MkRmUGs3aDBRd1FOb044REZmUTNObkpyU3ZFakJuU1Flc2JPaGV2V0M0Y2VpazRGODNzCnpURGNMZGROMkRaNTRteHhhNjY0OFc1TUhGVWM0ZHJldkdNL2RIeExHeVM1dDlJUENRT1poallNUHVFMnNpbDMKNHc1Q2dCZVl4YUVCV2VMM0FVbllsck5NazdsSUJ2dlk5ZVlRTSsydFRDZTNjSXBvY0pVU0pyME5USi9JVzFnUAprSWZtclhTaEc0cDhYdTZKZUlSL3g5ZkthYS9VS2NmTnhiQ0RZd0Z0QjU4RjV1c0NBd0VBQWFOa01HSXdIUVlEClZSME9CQllFRkYwM2JGV1k1T3lsb3kxR25sdUw4Z0ZBdVJNWE1COEdBMVVkSXdRWU1CYUFGRjAzYkZXWTVPeWwKb3kxR25sdUw4Z0ZBdVJNWE1BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0R3WURWUjBSQkFnd0JvY0VyQkVBQXpBTgpCZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFJbzd0MDd0aFN6dWpQWTc2c1U3SHNDY2t0b05uUk8vZzc0RC9ROFJJCjBjZUptYThrZDBUaGsxcFh5Q1cyUklPL0xMbE13RXU4Sko2bW9DVjJNaExZWHhJdjFJejhYNy9BOGYxMVdWMWcKOFZMcEFQQnBjUFJhcDEza0s2UW00WlBYdmVpTDB3VUJsUmx4dGJ3bXl2eWVZM0xPa2RrQnVrbE9BN2hVV1F2cwpkdmhKZGhRMTlWZ1E3SGVIeWF6OGVIMzdzejB3bFhFRUlxemM1V3RhR3g2NkZva0xMbFVOc1JYc0I4bktjS3E3CjJtdXZUVURrRThtTlNWcjBJdzIrUWN2aUx1NndzOEcvWmJGeHY2ZVRLWXpJczJ1djZ0RzZsYVZFK0JjcHRIcHkKK3YxK0NzOTYrTStyVzJkWllNRHlrV1pKamptQkJXak8wVFRLbVY5TEFVbElFdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
      insecureTLSSkipVerify: true
```



验证

```sh
vim restore-apply.yaml
kubectl apply -f restore-apply.yaml
restore.resources.cattle.io/restore-migration created

# 看restore状态
kubectl get restore
NAME                BACKUP-SOURCE   BACKUP-FILE                                                              AGE   STATUS
restore-migration                   minio-59ae5e34-b0b5-484a-9c51-d4df16766257-2022-06-06T07-19-59Z.tar.gz   8s


# 看log
kubectl get pods -n cattle-resources-system
NAME                             READY   STATUS    RESTARTS   AGE
rancher-backup-94944dc7b-b87z9   1/1     Running   0          3h5m

kubectl logs -n cattle-resources-system --tail 100 -f rancher-backup-94944dc7b-b87z9



# 成功后可以开始安装rancher
kubectl get restore
NAME                BACKUP-SOURCE   BACKUP-FILE                                                              AGE     STATUS
restore-migration   S3              minio-59ae5e34-b0b5-484a-9c51-d4df16766257-2022-06-06T07-19-59Z.tar.gz   4m52s   Completed
```

参考上面安装高可用rancher2.6.5，**rancher安装命令hostname和A安装的保持一致**
---
layout:     post
rewards: false
title:   kubeflow ç§æœ‰åŒ–éƒ¨ç½²å’Œä¸€äº›å¼€å‘çš„å‘ä½
categories:
    - k8s

---

# kubeflow å®‰è£…æ­¥éª¤

æ ¹æ®[kubeflow/mainfests](https://github.com/kubeflow/manifests)ä¸Šé¢çš„æµç¨‹å®‰è£…[1.4.1ç‰ˆæœ¬](https://github.com/kubeflow/manifests/releases/tag/v1.4.1)

æœ€å¥½å®‰è£…é¡ºåºæ­¥éª¤æ¥ä¸€ä¸ªä¸ªç»„ä»¶è£…ï¼Œæ³¨æ„[kustomizeç‰ˆæœ¬å’ŒKubernetesç‰ˆæœ¬](https://github.com/kubeflow/manifests#prerequisites)

# ç§æœ‰åŒ–éƒ¨ç½²

å°½é‡è·å–kubeflowé‡Œé¢çš„é•œåƒåœ°å€

```sh
images_file=images.txt


./kustomize/kustomize_3.2.0_darwin_amd64 build manifests/example | grep image: | sed -e 's/[ ]*image:[ ]*//' -e 's/"//g' | sort -u > $images_file

```

ä¸‹è½½image pushåˆ°ç§æœ‰ä»“åº“

```sh
images_file=images.txt
push256=images256.txt
push_image=imagespush.txt
repo=xxxxx:8080/library
version=kf-manifests-1.4.1

cat $images_file | grep @sha256 | sed -e 's/[ ]*@sha256:.*//' -e 's/"//g' > $push256
cat $images_file | grep -v @sha256 > $push_image

for pull_image in $(cat $images_file)
do
  echo "å¼€å§‹æ‹‰å–$pull_image..."
  docker pull $pull_image
done

for image in $(cat $push_image)
do
  echo "push $image..."
  docker tag $image $repo/$image
  docker push $repo/$image
done

for image in $(cat $push256)
do
  image_id=$(docker images|grep $image|awk '{print $3}'|sort -u)
  echo "push $image...$image_id"
  docker tag $image_id  $repo/$image:$version
  docker push $repo/$image:$version
done

```



```
istio/proxyv2:1.9.6
```

istio/proxyè¦å¦å¤–pushä¸èƒ½ç›´æ¥å…¨éƒ¨æ”¾åˆ°



## ç§æœ‰åŒ–é•œåƒ

éœ€è¦åˆ°çš„é•œåƒåœ¨**images.txt** ç”±**get_images.sh**ç”Ÿæˆ+é¢å¤–ç¼ºçš„åŒ…

é€šè¿‡**push_images.sh**æ‹‰å–å’Œpushåˆ°ç§æœ‰ä»“åº“

ç”Ÿæˆ**manifests.yamlå¹¶ä¿®æ”¹**

```shell
./kustomize/kustomize_3.2.0_darwin_amd64 build manifests/example > manifests.yaml
```

ä½¿ç”¨ä¿®æ”¹å¥½çš„manifests.yamléƒ¨ç½²

```shell
cat manifests.yaml| kubectl apply -f -
```

### é‡åˆ°çš„é—®é¢˜

- `gcr.io/arrikto/kubeflow/oidc-authservice:28c59ef` pushåˆ°ç§æœ‰åæ‹‰ä¸ä¸‹æ¥

![img](https://cdn.jsdelivr.net/gh/631068264/img/008i3skNly1gxvv85mdlcj31sc0eqwj1.jpg)



**éœ€è¦ä¿®æ”¹ä»“åº“åœ°å€**

- å¸¦sha256çš„é•œåƒç§æœ‰åŒ–åshaä¼šæ”¹å˜æ‹‰ä¸ä¸‹æ¥

  ![img](https://cdn.jsdelivr.net/gh/631068264/img/008i3skNgy1gyt4pqqn6yj31sc0eqjvx.jpg)

- å±‚çº§å¤ªå¤šä¸æŒ‡å®šé¡¹ç›®åpullä¸äº†ï¼Œå³ä½¿pushåˆ°libraryé¡¹ç›®é‡Œé¢

  ![img](https://cdn.jsdelivr.net/gh/631068264/img/008i3skNgy1gyt4pr2xnuj31sc0eqjvx.jpg)
  
  

### è§£å†³

ä»images.txtåˆ°push tagè½¬æ¢ç”±**push_img.shè§£å†³**ï¼Œmanifest.yamlç›®å‰æ‰‹åŠ¨æ›¿æ¢å¯¹åº”é•œåƒå

| images.txt                                                   | push tag                                                     | manifest.yaml                                                |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| docker.io/istio/proxyv2:1.9.6                                | xxx:xx/library/docker.io/istio/proxyv2:1.9.6                 | library/docker.io/istio/proxyv2:1.9.6                        |
| gcr.io/knative-releases/knative.dev/eventing/cmd/broker/filter@sha256:0e25aa1613a3a1779b3f7b7f863e651e5f37520a7f6808ccad2164cc2b6a9b12 | xxx:xx/library/gcr.io/knative-releases/knative.dev/eventing/cmd/broker/filter:kf-manifests-1.4.1 | library/gcr.io/knative-releases/knative.dev/eventing/cmd/broker/filter:kf-manifests-1.4.1 |

## kfserving

éœ€è¦ä¿®æ”¹ConfigMap inferenceservice-config

imageå¿…é¡»å†™å®Œæˆè·¯å¾„`xxx.xxx.xx.203:8080/library/pytorch/torchserve-kfs`ä¸ç„¶pullä¸äº†

# å®‰è£…é‡åˆ°çš„é—®é¢˜

## service "istio-galley" not found

```plaintext
    2020-05-22T14:11:35.511996Z	error	installer	failed to create "EnvoyFilter/istio-system/metadata-exchange-1.4": Internal error occurred: failed calling webhook "pilot.validation.istio.io": Post https://istio-galley.istio-system.svc:443/admitpilot?timeout=30s: service "istio-galley" not found
    2020-05-22T14:11:35.586916Z	error	installer	failed to create "EnvoyFilter/istio-system/metadata-exchange-1.5": Internal error occurred: failed calling webhook "pilot.validation.istio.io": Post https://istio-galley.istio-system.svc:443/admitpilot?timeout=30s: service "istio-galley" not found
    2020-05-22T14:11:35.626408Z	error	installer	failed to create "EnvoyFilter/istio-system/metadata-exchange-1.6": Internal error occurred: failed calling webhook "pilot.validation.istio.io": Post https://istio-galley.istio-system.svc:443/admitpilot?timeout=30s: service "istio-galley" not found
    2020-05-22T14:11:35.664555Z	error	installer	failed to create "EnvoyFilter/istio-system/stats-filter-1.4": Internal error occurred: failed calling webhook "pilot.validation.istio.io": Post https://istio-galley.istio-system.svc:443/admitpilot?timeout=30s: service "istio-galley" not found
    2020-05-22T14:11:35.712217Z	error	installer	failed to create "EnvoyFilter/istio-system/stats-filter-1.5": Internal error occurred: failed calling webhook "pilot.validation.istio.io": Post https://istio-galley.istio-system.svc:443/admitpilot?timeout=30s: service "istio-galley" not found
    2020-05-22T14:11:35.750036Z	error	installer	failed to create "EnvoyFilter/istio-system/stats-filter-1.6": Internal error occurred: failed calling webhook "pilot.validation.istio.io": Post https://istio-galley.istio-system.svc:443/admitpilot?timeout=30s: service "istio-galley" not found
```

æœ‰å¯èƒ½æ˜¯[å¸è½½ä¸å¹²å‡€](https://github.com/istio/istio/issues/24044)

```shell
kubectl delete validatingwebhookconfigurations istio-galley
```

å†apply

## httpè®¾ç½®

![img](https://cdn.jsdelivr.net/gh/631068264/img/008i3skNgy1gyt56wzvglj31n00su0vw.jpg)



**å·²ç»åœ¨`mainfests.yml`æ”¹äº†**

- centraldashboard
- jupyter-web-app-deployment
- katib-ui
- kfserving-models-web-app
- ml-pipeline-ui
- tensorboards-web-app-deployment
- volumes-web-app-deployment

åœ¨è¿™å‡ ä¸ªåå­—çš„Deploymenté‡Œé¢æ·»åŠ envå‚æ•°

```plaintext
        - name: APP_SECURE_COOKIES
          value: "false"
```

httpså‚è€ƒ

- https://github.com/kubeflow/kubeflow/issues/5803
- https://github.com/kubeflow/manifests/pull/1819/files

## å®‰è£…åˆ°k8s1.19é‡åˆ°TokenRequestçš„é—®é¢˜

ç‰ˆæœ¬ï¼šrkeå®‰è£…k8s-1.19.6ã€kubeflow-1.4

istioç»„ä»¶å®‰è£…æ—¶æŠ¥é”™

  ğŸ’¡ MountVolume.SetUp failed for volume "istio-token" : failed to fetch token: the API server does not have TokenRequest endpoints enabled 

æ‰§è¡Œä¸‹é¢è„šæœ¬å‘ç°æ˜¯é›†ç¾¤æ²¡æœ‰TokenRequest

```shell
kubectl get --raw /api/v1 | jq '.resources[] | select(.name | index("serviceaccounts/token"))'
```

### è§£å†³æ–¹å¼

è®¾ç½®å˜é‡jwtPolicy

values.global.jwtPolicy=first-party-jwt

å‚è€ƒï¼šhttps://stackoverflow.com/questions/64641078/how-to-install-kubeflow-on-existing-on-prem-kubernetes-cluster

# multi-user é—®é¢˜

- https://v1-4-branch.kubeflow.org/docs/components/multi-tenancy/getting-started/

## æ–°å¢ç”¨æˆ·

add_profile.yaml

```yaml
apiVersion: kubeflow.org/v1beta1
kind: Profile
metadata:
  name: kubeflow-admin-example-com # ç”¨æˆ·namespace
spec:
  owner:
    kind: User
    name: admin@example.com # ç”¨æˆ·å
kubectl apply -f add_profile.yaml
```

[æ–°å¢dexçš„config map](https://github.com/kubeflow/manifests#change-default-user-password)

```yaml
    staticPasswords:
    - email: user@example.com
      hash: $2y$12$4K/VkmDd1q1Orb3xAt82zu8gk7Ad6ReFR4LCP9UeYE90NLiN9Df72
      # https://github.com/dexidp/dex/pull/1601/commits
      # FIXME: Use hashFromEnv instead
      username: user
      userID: "15841185641784"
    - email: admin@example.com
      hash: $2y$12$uTQwnB7afyNhob.6ETtbdOSTtwvFgqdo9/6yyDi3RZZuk6OqWgsR6
      username: admin
```

ç”Ÿæˆhashéœ€è¦`pip install passlib bcrypt`

```shell
python3 -c 'from passlib.hash import bcrypt; import getpass; print(bcrypt.using(rounds=12, ident="2y").hash(getpass.getpass()))'
```

è¾“å…¥å¯†ç å›è½¦å°±å¯ä»¥å¾—åˆ°éœ€è¦çš„hash

**æœ€åé‡å¯ä¸‹dexå¯¹åº”çš„pod**

# å¼€å‘ç›¸å…³

## è‡ªå®šä¹‰Jupyteré•œåƒ

[è‡ªå®šä¹‰Jupyteré•œåƒ](https://github.com/kubeflow/kubeflow/tree/master/components/example-notebook-servers#custom-images) å› ä¸ºæ¯ä¸ªäººéœ€è¦çš„åŒ…ç‰ˆæœ¬ä¸ä¸€æ ·

## pipeline sdk

æš‚æ—¶ä¸è¦ç”¨[v2ç‰ˆæœ¬çš„](https://github.com/kubeflow/pipelines/blob/ec9021f5b04521d394fb3a95903b86b478bf6550/v2/test/README.md)ï¼Œkubeflowä¼šæŠ¥é”™

```plaintext
 main.go:50] Failed to execute component: unable to get pipeline with PipelineName "pipeline/v2add" PipelineRunID "7e2bdeeb-aa6f-4109-a508-63a1be22267c": Failed GetContextByTypeAndName(type="system.Pipeline", name="pipeline/v2add")
```

[sdk sample](https://github.com/kubeflow/pipelines/tree/master/samples)

## kfserving

éœ€è¦ä½¿ç”¨py3.9ä¸ç„¶å®‰è£…`ray[serve]==1.5.0`ä¾èµ–ä¼šæŠ¥é”™

## fairing

```shell
pip install kubeflow-fairing
```

æ ¹æœ¬å®‰è£…ä¸äº†ï¼Œ**ä¾èµ–å†²çª**, è¿˜æœ‰ä¸åœå®‰è£…åŒä¸ªåŒ…ä¸åŒç‰ˆæœ¬çš„é—®é¢˜ã€‚ä¸€å¥è¯æ ¹æœ¬æ²¡æ³•è£…

```shell
$ pip-compile -r test_req.in
Could not find a version that matches kubernetes==10.0.1,>=10.0.1,>=12.0.0 (from kubeflow-fairing==1.0.2->-r test_req.in (line 1))
Tried: 1.0.0, 1.0.0, 1.0.1, 1.0.1, 1.0.2, 1.0.2, 2.0.0, 2.0.0, 3.0.0, 3.0.0, 4.0.0, 4.0.0, 5.0.0, 5.0.0, 6.0.0, 6.0.0, 6.1.0, 6.1.0, 7.0.0, 7.0.0, 7.0.1, 7.0.1, 8.0.0, 8.0.0, 8.0.1, 8.0.1, 8.0.2, 8.0.2, 9.0.0, 9.0.0, 9.0.1, 9.0.1, 10.0.0, 10.0.0, 10.0.1, 10.0.1, 10.1.0, 10.1.0, 11.0.0, 11.0.0, 12.0.0, 12.0.0, 12.0.1, 12.0.1, 17.17.0, 17.17.0, 18.20.0, 18.20.0, 19.15.0, 19.15.0
Skipped pre-versions: 0.0.0a2, 0.0.0a2, 0.0.0a5, 0.0.0a5, 1.0.0a2, 1.0.0a2, 1.0.0a3, 1.0.0a4, 1.0.0a4, 1.0.0a5, 1.0.0a5, 1.0.0b1, 1.0.0b1, 1.0.0b2, 1.0.0b2, 1.0.0b3, 1.0.0b3, 2.0.0a1, 2.0.0a1, 2.0.0b1, 2.0.0b1, 3.0.0a1, 3.0.0a1, 3.0.0b1, 3.0.0b1, 4.0.0a1, 4.0.0a1, 4.0.0b1, 4.0.0b1, 5.0.0b1, 5.0.0b1, 6.0.0b1, 6.0.0b1, 7.0.0a1, 7.0.0a1, 7.0.0b1, 7.0.0b1, 8.0.0a1, 8.0.0a1, 8.0.0b1, 8.0.0b1, 9.0.0a1, 9.0.0a1, 9.0.0b1, 9.0.0b1, 10.0.0a1, 10.0.0a1, 11.0.0a1, 11.0.0a1, 11.0.0b1, 11.0.0b1, 11.0.0b2, 11.0.0b2, 12.0.0a1, 12.0.0a1, 12.0.0b1, 12.0.0b1, 17.14.0a1, 17.14.0a1, 17.17.0b1, 17.17.0b1, 18.17.0a1, 18.17.0a1, 18.20.0b1, 18.20.0b1, 19.15.0a1, 19.15.0a1, 19.15.0b1, 19.15.0b1, 20.11.0a1, 20.11.0a1, 20.12.0b1, 20.12.0b1
There are incompatible versions in the resolved dependencies:
  kubernetes>=10.0.1 (from kubeflow-tfjob==0.1.3->kubeflow-fairing==1.0.2->-r test_req.in (line 1))
  kubernetes>=12.0.0 (from kfserving==0.6.1->kubeflow-fairing==1.0.2->-r test_req.in (line 1))
  kubernetes>=10.0.1 (from kubeflow-pytorchjob==0.1.3->kubeflow-fairing==1.0.2->-r test_req.in (line 1))
  kubernetes==10.0.1 (from kubeflow-fairing==1.0.2->-r test_req.in (line 1))
```

kubeflow-fairingæœ‰å¤šä¸ªä¾èµ–åŒ…ï¼Œkfservingæ¯”è¾ƒæ–°ã€‚å…¶ä»–åŒ…å¥½è€ï¼ˆæœ‰ç»´æŠ¤ä½†æ˜¯ä¸releaseï¼‰ï¼Œfairingæœ¬èº«ä¹Ÿæ²¡æœ‰å…¼å®¹æœ€æ–°çš„kfservingã€‚

ä¸»è¦æ˜¯k8s clientä»11.xxå¼€å§‹ä»swagger_typesæ¢æˆopenapi_typesï¼Œè€Œå…¶ä»–åŒ…ä¹Ÿæ²¡æœ‰è·Ÿä¸Š

- https://github.com/kubeflow/training-operator/pull/1143 ( [Kubeflow Training Operator](https://github.com/kubeflow/training-operator) )
- [AttributeError: 'V1TFJob' object has no attribute 'openapi_types'](https://github.com/kubernetes-client/python/issues/1112)

[ä½¿ç”¨è‡ªå·±ç»´æŠ¤fairingçš„adapt-latest-kfserving-and-training-opratoråˆ†æ”¯](https://github.com/kubeflow/fairing/pull/567)æ‰“åŒ…whlåŒ…

```shell
#!/bin/bash

rm -rf build
rm -rf dist
rm -rf kubeflow_fairing.egg-info

python setup.py bdist_wheel
```

å¯ä»¥åœ¨é¡¹ç›®çš„distç›®å½•æ‰¾åˆ°å¯¹åº”çš„whlæ–‡ä»¶

![img](https://cdn.jsdelivr.net/gh/631068264/img/008i3skNgy1gyt5dx93exj30wc0n0402.jpg)



ç„¶åä½¿ç”¨`pip install xxx.whl`å°±å¯ä»¥å®‰è£…

# æ¨¡å‹çŠ¶æ€åˆ¤æ–­

- æ­£å¸¸

  ```json
  "conditions": [
             ......
              {
                  "lastTransitionTime": "2022-01-27T01:49:37Z",
                  "status": "True",
                  "type": "Ready"
              }
    ]
  ```

  [åˆ¤æ–­ ready true  å®˜æ–¹é€šè¿‡inferenceServiceReadinessåˆ¤æ–­](https://github.com/kserve/kserve/blob/ff608cf68efe4711d155c648d034a4c37cd73b9a/pkg/controller/v1beta1/inferenceservice/controller.go#L194)

- å¼‚å¸¸

  ```json
  "conditions": [
          
  
              {
                  "lastTransitionTime": "2022-01-27T01:54:52Z",
                  "message": "Revision \"test-sklearn-predictor-default-00001\" failed with message: 0/3 nodes are available: 1 Insufficient memory, 3 Insufficient cpu..",
                  "reason": "RevisionFailed",
                  "severity": "Info",
                  "status": "False",
                  "type": "PredictorRouteReady"
              },
              {
                  "lastTransitionTime": "2022-01-27T01:54:52Z",
                  "message": "Configuration \"test-sklearn-predictor-default\" does not have any ready Revision.",
                  "reason": "RevisionMissing",
                  "status": "False",
                  "type": "Ready"
              }
          ]
  ```

  éå†conditions  if reason=="RevisionFailed" å°±æ˜¯å¼‚å¸¸ï¼Œç„¶åæ‹¿å®ƒmessage

- éƒ¨ç½²ä¸­

  å…¶ä»–æƒ…å†µéƒ½æ˜¯éƒ¨ç½²ä¸­

[è¦æŸ¥çœ‹kservingé‡Œé¢èµ‹å€¼conditionsçš„ä»£ç ï¼Œä¸»è¦çœ‹InferenceServiceStatus.PropagateStatusæ–¹æ³•](https://github.com/kserve/kserve/blob/ff608cf68efe4711d155c648d034a4c37cd73b9a/pkg/apis/serving/v1beta1/inference_service_status.go#L151)

```go
func (ss *InferenceServiceStatus) PropagateStatus(component ComponentType, serviceStatus *knservingv1.ServiceStatus) {
	....
	// propagate overall service condition
	serviceCondition := serviceStatus.GetCondition(knservingv1.ServiceConditionReady)
	if serviceCondition != nil && serviceCondition.Status == v1.ConditionTrue {
		if serviceStatus.Address != nil {
			statusSpec.Address = serviceStatus.Address
		}
		if serviceStatus.URL != nil {
			statusSpec.URL = serviceStatus.URL
		}
	}
	// propagate ready condition for each component
	readyCondition := conditionsMap[component]
	ss.SetCondition(readyCondition, serviceCondition)
	// propagate route condition for each component
	routeCondition := serviceStatus.GetCondition("ConfigurationsReady")
	routeConditionType := routeConditionsMap[component]
	ss.SetCondition(routeConditionType, routeCondition)
	// propagate configuration condition for each component
	configurationCondition := serviceStatus.GetCondition("RoutesReady")
	configurationConditionType := configurationConditionsMap[component]
	// propagate traffic status for each component
	statusSpec.Traffic = serviceStatus.Traffic
	ss.SetCondition(configurationConditionType, configurationCondition)

	ss.Components[component] = statusSpec
}
```



ä¸€ç›´**è¿½è¸ªå‡½æ•°æµç¨‹**ï¼Œç®€åŒ–ä¸€ä¸‹ï¼ˆ[å…¶å®æœ‰ç‚¹æƒ³ä¸æ˜ç™½ï¼Œæœ€åä¸¤ä¸ªå€¼ä¸ºä»€ä¹ˆè¿™æ ·èµ‹å€¼ï¼Œå˜é‡åå¥½å¥‡æ€ªï¼Œæ„Ÿè§‰å¥½åƒåäº†](https://github.com/kserve/kserve/issues/2012)ï¼‰

| æ ¹æ®componentä¼šä¸ä¸€æ ·       | serviceStatus æ¥è‡ªäºknative client |
| --------------------------- | ---------------------------------- |
| PredictorReady              | Ready                              |
| PredictorRouteReady         | ConfigurationsReady                |
| PredictorConfigurationReady | RoutesReady                        |

[æ¯”è¾ƒé¡¶çº§api](https://github.com/kserve/kserve/blob/ff608cf68efe4711d155c648d034a4c37cd73b9a/pkg/controller/v1beta1/inferenceservice/controller.go#L68)  å…ˆè°ƒç”¨knativeåˆ›å»ºä¸Šé¢çš„ç»„ä»¶ï¼ˆcomponentsï¼‰knativeï¼Œç„¶ååœ¨åˆ›å»ºingressç›¸å…³çš„setting **IngressReady**

```go
reconcilers := []components.Component{
  components.NewPredictor(r.Client, r.Scheme, isvcConfig),
}
if isvc.Spec.Transformer != nil {
  reconcilers = append(reconcilers, components.NewTransformer(r.Client, r.Scheme, isvcConfig))
}
if isvc.Spec.Explainer != nil {
  reconcilers = append(reconcilers, components.NewExplainer(r.Client, r.Scheme, isvcConfig))
}
for _, reconciler := range reconcilers {
  if err := reconciler.Reconcile(isvc); err != nil {
    r.Log.Error(err, "Failed to reconcile", "reconciler", reflect.ValueOf(reconciler), "Name", isvc.Name)
    r.Recorder.Eventf(isvc, v1.EventTypeWarning, "InternalError", err.Error())
    return reconcile.Result{}, errors.Wrapf(err, "fails to reconcile component")
  }
}
//Reconcile ingress
ingressConfig, err := v1beta1api.NewIngressConfig(r.Client)
if err != nil {
  return reconcile.Result{}, errors.Wrapf(err, "fails to create IngressConfig")
}
reconciler := ingress.NewIngressReconciler(r.Client, r.Scheme, ingressConfig)
r.Log.Info("Reconciling ingress for inference service", "isvc", isvc.Name)
if err := reconciler.Reconcile(isvc); err != nil {
  return reconcile.Result{}, errors.Wrapf(err, "fails to reconcile ingress")
}

// Reconcile modelConfig
configMapReconciler := modelconfig.NewModelConfigReconciler(r.Client, r.Scheme)
if err := configMapReconciler.Reconcile(isvc); err != nil {
  return reconcile.Result{}, err
}

if err = r.updateStatus(isvc); err != nil {
  r.Recorder.Eventf(isvc, v1.EventTypeWarning, "InternalError", err.Error())
  return reconcile.Result{}, err
}
```

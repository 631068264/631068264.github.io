---
layout:     post
rewards: false
title:   集群排错
categories:
    - k8s


---



# 下游集群连不上Rancher排查

![image-20220519173544137](https://tva1.sinaimg.cn/large/e6c9d24egy1h33kfc16fgj220q0jcdj9.jpg)

- 检查端口连通性，**要分段排查**，**注意数据方向**

  - 前置机状态

  - 前置机nginx状态，端口监听是否异常，nginx配置是否被篡改

  - 防火墙是否关闭或者iptable是否很怪

    ```sh
    # 防火墙
    systemctl status/disable/stop firewalld
    
    # 查看iptable,将配置导出到xx方便看
    iptables-save > xx
    ```

- 先尝试连上**下游集群主节点**是否正常，**必要时候重启节点**

  - ping 不通

  - ssh 连不上

  - 根据提示语（rancher有时候有明确提示语）查看组件log或者重启组件（kubelet,kube-apiserver之类）,dokcer重启

    ```sh
    docker ps |grep  xxx
    docker logs -f --tail 100 xxx
    ```

  - 查看pod是否正常

    ```sh
    # rancher 相关的pod
    kubectl get pod -n cattle-system
    
    # 所有pod
    kubectl get pod -A
    ```

    遇到域名解析问题，集群需要修改coredns的configmap，然后重启coredns

    ```sh
    kubectl edit cm coredns -n kube-system
    ```

    参照/etc/hosts修改

    ```
    hosts {
            xxx harbor.xxxx.cn
            fallthrough
    }
    ```

    重启coredns
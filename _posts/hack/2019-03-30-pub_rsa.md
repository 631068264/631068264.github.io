---
layout:     post
rewards: false
title:      å¯†ç 
categories:
    - hack
tags:
    - security
---

# ç§é’¥/å…¬é’¥åŠ å¯†ç®—æ³•ï¼ˆå¯¹ç§°/éå¯¹ç§°ï¼‰

<span class='heimu'>å¾ˆè®¨åŒä¸€æ ·ä¸œè¥¿æœ‰ä¸¤æ ·åå­—ï¼Œè€ƒé¢˜è€ƒå®˜æ€»èƒ½æ‹¿æ²¡å¬è¿‡çš„è€ƒä½ </span>ğŸ¤£

ç®—æ³•ç”Ÿæˆä¸€å¯¹å¯†é’¥ç”¨äºåŠ å¯†è§£å¯†
- å¯†é’¥ç›¸åŒ **å¯¹ç§°/ç§é’¥ åŠ å¯†**
- å¯†é’¥ä¸åŒ **éå¯¹ç§°/å…¬é’¥ åŠ å¯†** å…¬é’¥å¯å…¬å¼€ï¼Œç§é’¥è‡ªå·±ç•™ç€ï¼Œ**åŒä¸€å¯†é’¥å¯¹å¯ä»¥è§£å¯¹æ–¹åŠ çš„å¯†**

## å¸¸ç”¨ç®—æ³•

### å¯¹ç§°
AES,DES,3DESï¼ŒRC5ã€RC6

> åŠ å¯†è§£å¯†æ•ˆç‡é«˜ï¼Œ**é€Ÿåº¦å¿«**ï¼Œé€‚åˆè¿›è¡Œ**å¤§æ•°æ®é‡**çš„åŠ è§£å¯†

### éå¯¹ç§°
RSAã€DSAã€ECC

> ç®—æ³•å¤æ‚ï¼ŒåŠ è§£å¯†**é€Ÿåº¦æ…¢**ï¼Œä½†**å®‰å…¨æ€§é«˜**

### hash

MD5ã€SHAç³»åˆ—ã€HMAC åŠ ç›

åŒè¾“å…¥åŒç®—æ³•åŒè¾“å‡ºï¼ŒåŒè¾“å‡ºä¸ä¸€å®šè¾“å…¥ç›¸åŒ(**ä¸èƒ½åæ¨**)


# æ¶ˆæ¯åŠ å¯†

> é€šä¿¡å®‰å…¨

ç”¨**éå¯¹ç§°åŠ å¯†**ï¼Œ**å¯¹ç§°**çš„è¯å¯†é’¥æ³„æ¼å°±å®Œè›‹

- S : å‘é€è€…
- R : æ¥æ”¶è€…


$$ R\xrightarrow{\mathrm{å…¬é’¥}}S $$

$$ S: R\mathrm{å…¬é’¥}+\mathrm{åŸå§‹ä¿¡æ¯}=\mathrm{å¯†æ–‡} $$

$$ S\xrightarrow{\mathrm{å¯†æ–‡}}R $$

$$ R:\;R\mathrm{ç§é’¥}+\mathrm{å¯†æ–‡}=\mathrm{åŸå§‹ä¿¡æ¯} $$



# æ•°å­—ç­¾å

> ç¡®ä¿æ¶ˆæ¯**æ¥æº**,**ä¸è¢«ç¯¡æ”¹**

- S : å‘é€è€…
- R : æ¥æ”¶è€…
- M: Man-in-the-middle attack

$$ S\xrightarrow{\mathrm{å…¬é’¥}}R $$

$$ S\;:\;\mathrm{åŸå§‹æ¶ˆæ¯}+\;HASH=\mathrm{æ‘˜è¦}(digest)+\;S\mathrm{ç§é’¥åŠ å¯†}\;=\;\mathrm{æ•°å­—ç­¾å}(signature) $$

$$ S\xrightarrow{\mathrm{åŸå§‹æ¶ˆæ¯}\;and\;\;\mathrm{æ•°å­—ç­¾å}}R $$

$$ R\;\left\{\begin{array}{l}\mathrm{åŸå§‹æ¶ˆæ¯}\;\xrightarrow[{HASH}]{}\mathrm{æ‘˜è¦}A\\\mathrm{åŠ å¯†æ‘˜è¦}\xrightarrow[{\mathrm{Så…¬é’¥è§£å¯†}\;\;\;}]{}\mathrm{æ‘˜è¦}B\end{array}\rightarrow\right.\mathrm{æ‘˜è¦}A/B\mathrm{å¯¹æ¯”}\rightarrow\mathrm{æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹} $$

> è¿™é‡Œçš„åŸå§‹æ¶ˆæ¯ä¹Ÿ**å¯ä»¥ç»è¿‡åŠ å¯†ï¼Œè¿™æ ·å°±ä¸æ˜¯æ˜æ–‡äº†ï¼Œå®‰å…¨æ€§æ›´å¥½**



- Why åŠ å¯†æ‘˜è¦ not ç›´æ¥å‘æ‘˜è¦

> ç›´æ¥å‘æ‘˜è¦Må¯ä»¥æ›¿æ¢å‘é€çš„æ¶ˆæ¯å’Œæ‘˜è¦ï¼Œä½†æ— æ³•å®ŒæˆåŠ å¯†ã€‚**é€šè¿‡ç§é’¥åŠ å¯†è¯æ˜å‘é€è€…çš„èº«ä»½**ï¼Œåªæœ‰å”¯ä¸€çš„å…¬é’¥è§£å¯†ï¼Œå…¶ä»–äººæ— æ³•ä¼ªé€ ã€‚

- Why åŠ å¯†æ‘˜è¦ not åŠ å¯†æ¶ˆæ¯

> æ¶ˆæ¯é‡å¤§çš„è¯åŠ å¯†æ—¶é—´é•¿ï¼Œæ‘˜è¦æ˜¯å›ºå®šé•¿åº¦çš„ã€‚


# æ•°å­—è¯ä¹¦

å½“Ræ‹¿åˆ°Så…¬é’¥å…¶å®æ˜¯**Må…¬é’¥**æ—¶ï¼Œä¸€åˆ‡å´©åã€‚Må¯ä»¥å®Œå…¨å–ä»£Så‘é€æ¶ˆæ¯ï¼ŒRä¼šè§‰å¾—Mæ‰æ˜¯Sï¼ŒSæ˜¯å…¶ä»–äººã€‚

> **è¯ä¹¦ä¸­å¿ƒ**ï¼ˆcertificate authorityï¼Œç®€ç§°CAï¼‰ä¸ºå…¬é’¥åšè®¤è¯ã€‚è¯ä¹¦ä¸­å¿ƒç”¨è‡ªå·±çš„ç§é’¥ï¼Œå¯¹Så…¬é’¥å’Œä¸€äº›ç›¸å…³ä¿¡æ¯ä¸€èµ·**åŠ å¯†ç­¾å**ï¼Œç”Ÿæˆ**æ•°å­—è¯ä¹¦**ï¼ˆDigital Certificateï¼‰

$${\mathrm{è¯ä¹¦ä¸­å¿ƒ}(certificate\;authority)\mathrm{ç§é’¥}}+S\mathrm{å…¬é’¥}+\mathrm{ä¸€äº›}S\mathrm{çš„ä¿¡æ¯}=\mathrm{æ•°å­—è¯ä¹¦}(Digital\;Certificate)$$

$$ S\xrightarrow{\mathrm{åŸå§‹æ¶ˆæ¯}\;and\;\;\mathrm{æ•°å­—ç­¾å}\;and\;\mathrm{æ•°å­—ç­¾å}}R $$

$$ R:\;\mathrm{æ•°å­—ç­¾å}+CA\;\mathrm{å…¬é’¥}=S\mathrm{å…¬é’¥} $$

çŸ¥åCAæœºæ„çš„æ ¹è¯ä¹¦ä¼šå†…ç½®äºæ¸¸è§ˆå™¨ä¸­ï¼Œç”¨æ¥ç¡®ä¿ CA æœºæ„æœ¬èº«çš„èº«ä»½ï¼Œå…¶ä¸­å°±åŒ…å«äº† CA æœºæ„è‡ªèº«çš„å…¬é’¥ã€‚ä¼šéªŒè¯æ•°å­—è¯ä¹¦å¯é æ€§ã€‚

- Why CA å…¬é’¥éä¼ªé€ 
> CAæ˜¯ç¬¬ä¸‰æ–¹æœºæ„ï¼ŒCAå…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œæ¥æ”¶æ–¹å¯ä»¥è·Ÿåˆ«äººæ¯”å¯¹ï¼ˆæ¯”å¦‚åœ¨ç½‘ä¸ŠæŸ¥è¯¢ï¼‰ï¼Œå› æ­¤ä¸å¯èƒ½ä¼ªé€ ã€‚ä½†æ˜¯å‘é€æ–¹å…¬é’¥ï¼Œæ¥æ”¶æ–¹æ˜¯é€šè¿‡é€šä¿¡å¾—åˆ°çš„ï¼Œæ”¶åˆ°åæ— æ³•éªŒè¯ã€‚

## HTTPS

### Hello é˜¶æ®µ
- Clientç«¯å‘é€httpsè¯·æ±‚

> 1. æ”¯æŒçš„åè®®ç‰ˆæœ¬
> 2. éšæœºæ•° **random1**ï¼Œç¨åç”¨äºç”Ÿæˆ"å¯¹è¯å¯†é’¥"ã€‚
> 3. æ”¯æŒçš„åŠ å¯†æ–¹æ³•ç­‰ä¿¡æ¯

- Serverç«¯

> 1. ç¡®è®¤ä½¿ç”¨çš„åŠ å¯†é€šä¿¡åè®®ç‰ˆæœ¬
> 2. å‘é€éšæœºæ•° **random2**ï¼Œç¨åç”¨äºç”Ÿæˆ"å¯¹è¯å¯†é’¥"ã€‚
> 3. ç¡®è®¤åŠ å¯†æ–¹æ³•ç­‰ä¿¡æ¯
> 4. å‘é€æ•°å­—è¯ä¹¦

### éªŒè¯æ•°å­—è¯ä¹¦

- **CAèº«ä»½éªŒè¯/è¿‡æœŸ CAæ ¹è¯ä¹¦éªŒè¯**: æµè§ˆå™¨å†…ç½®ä¸€ä¸ªå—ä¿¡ä»»çš„**CAæœºæ„åˆ—è¡¨**ï¼Œå¹¶ä¿å­˜äº†è¿™äº›CAæœºæ„çš„è¯ä¹¦ã€‚

- **Serverç«¯çš„æ•°å­—è¯ä¹¦ä¿¡æ¯ä¸å½“å‰æ­£åœ¨è®¿é—®çš„ç½‘ç«™ï¼ˆåŸŸåç­‰ï¼‰ä¸€è‡´**: Serverç«¯æ˜¯å¯ä¿¡çš„ -> **è·å¾—Serverå…¬é’¥**

> Clientç«¯æ˜¯å¦èƒ½å¤Ÿä¿¡ä»»è¿™ä¸ªç«™ç‚¹çš„è¯ä¹¦ï¼Œé¦–å…ˆå–å†³äºClientç«¯ç¨‹åºæ˜¯å¦å¯¼å…¥äº†è¯ä¹¦é¢å‘è€…çš„æ ¹è¯ä¹¦ã€‚**æŠ“åŒ…å·¥å…·è¦æŠ“httpsä¹Ÿè¦å¯¼å…¥å·¥å…·çš„è¯ä¹¦**



### åå•†é€šä¿¡å¯†é’¥
ä¼ è¾“å†…å®¹çš„åŠ å¯†æ˜¯é‡‡ç”¨çš„**å¯¹ç§°åŠ å¯†**ï¼Œå¯¹åŠ å¯†çš„å¯†é’¥ä½¿ç”¨å…¬é’¥è¿›è¡Œ**éå¯¹ç§°åŠ å¯†**

- Serverç«¯éªŒè¯å®¢æˆ·ç«¯(**optional**) å®¢æˆ·ç«¯çš„è¯ä¹¦ + éšæœºæ•°(Clientç«¯ç­¾å) = **å®¢æˆ·ç«¯èº«ä»½éªŒè¯**
- éªŒè¯é€šè¿‡åClientç«¯ç”Ÿæˆ éšæœºç (**PreMaster key**)**Serverå…¬é’¥**åŠ å¯† [+ **å®¢æˆ·ç«¯èº«ä»½éªŒè¯**] -> Serverç«¯

PreMaster key =   RSAæˆ–è€…Diffie-Hellmanç­‰åŠ å¯†ç®—æ³•ç”Ÿæˆ

>PreMaster keyæ˜¯åœ¨å®¢æˆ·ç«¯ä½¿ç”¨RSAæˆ–è€…Diffie-Hellmanç­‰åŠ å¯†ç®—æ³•ç”Ÿæˆçš„ã€‚
>
>PreMaster keyå‰ä¸¤ä¸ªå­—èŠ‚æ˜¯TLSçš„ç‰ˆæœ¬å·ï¼Œè¿™æ˜¯ä¸€ä¸ª**æ¯”è¾ƒé‡è¦çš„ç”¨æ¥æ ¸å¯¹æ¡æ‰‹æ•°æ®çš„ç‰ˆæœ¬å·**ï¼Œå› ä¸ºåœ¨Client Helloé˜¶æ®µï¼Œ
>å®¢æˆ·ç«¯ä¼šå‘é€ä¸€ä»½åŠ å¯†å¥—ä»¶åˆ—è¡¨å’Œå½“å‰æ”¯æŒçš„SSL/TLSçš„ç‰ˆæœ¬å·ç»™æœåŠ¡ç«¯ï¼Œè€Œä¸”æ˜¯ä½¿ç”¨æ˜æ–‡ä¼ é€çš„ï¼Œ
>å¦‚æœæ¡æ‰‹çš„æ•°æ®åŒ…è¢«ç ´è§£ä¹‹åï¼Œæ”»å‡»è€…å¾ˆæœ‰å¯èƒ½ä¸²æ”¹æ•°æ®åŒ…ï¼Œé€‰æ‹©ä¸€ä¸ªå®‰å…¨æ€§è¾ƒä½çš„åŠ å¯†å¥—ä»¶å’Œç‰ˆæœ¬ç»™æœåŠ¡ç«¯ï¼Œä»è€Œå¯¹æ•°æ®è¿›è¡Œç ´è§£ã€‚
>æ‰€ä»¥ï¼ŒæœåŠ¡ç«¯éœ€è¦å¯¹å¯†æ–‡ä¸­è§£å¯†å‡ºæ¥å¯¹çš„PreMasterç‰ˆæœ¬å·è·Ÿä¹‹å‰Client Helloé˜¶æ®µçš„ç‰ˆæœ¬å·è¿›è¡Œå¯¹æ¯”ï¼Œ
>å¦‚æœç‰ˆæœ¬å·å˜ä½ï¼Œåˆ™è¯´æ˜è¢«ä¸²æ”¹ï¼Œåˆ™ç«‹å³åœæ­¢å‘é€ä»»ä½•æ¶ˆæ¯ã€‚

- Serverç«¯éªŒè¯ **å®¢æˆ·ç«¯èº«ä»½**(**optional**)è¿‡åï¼Œè§£å¯†å¾—åˆ°**PreMaster key** 
- åŒç«¯ç”Ÿæˆ**Master key** = ä¸€ç³»åˆ—ç®—æ³•(**PreMaster key** + **random1** +  **random2**)

- åŒç«¯ï¼šå‘é€**ChangeCipherSpecåè®®**ï¼Œæ•°æ®åŒ…ä¸­å°±æ˜¯ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œç”¨äºå‘ŠçŸ¥æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯å·²ç»**åˆ‡æ¢åˆ°ä¹‹å‰åå•†å¥½çš„åŠ å¯†å¥—ä»¶**ï¼ˆCipher Suiteï¼‰çš„çŠ¶æ€ï¼Œå‡†å¤‡ä½¿ç”¨ä¹‹å‰åå•†å¥½çš„åŠ å¯†å¥—ä»¶åŠ å¯†æ•°æ®å¹¶ä¼ è¾“äº†ã€‚
- åŒç«¯ï¼šåå•†å¥½çš„åŠ å¯†å¥—ä»¶å’ŒSession SecretåŠ å¯†ä¸€æ®µ **Finish** çš„æ•°æ®ä¼ é€ç»™æœåŠ¡ç«¯ï¼Œæ­¤æ•°æ®æ˜¯ä¸ºäº†åœ¨æ­£å¼ä¼ è¾“åº”ç”¨æ•°æ®ä¹‹å‰å¯¹åˆšåˆšæ¡æ‰‹å»ºç«‹èµ·æ¥çš„åŠ è§£å¯†é€šé“è¿›è¡ŒéªŒè¯ã€‚


> å¦‚æœ**PreMaster key**æ³„æ¼ å®Œè›‹äº†

### é€šä¿¡è¿‡ç¨‹

S: åŠ å¯†(æ¶ˆæ¯+æ¶ˆæ¯æ‘˜è¦) R: è§£å¯† å¯¹æ¯”æ‘˜è¦

# code
```python
def to_bytes(bytes_or_str):
    if isinstance(bytes_or_str, str):
        return bytes_or_str.encode()
    return bytes_or_str


def to_str(bytes_or_str):
    if isinstance(bytes_or_str, bytes):
        return bytes_or_str.decode()
    return bytes_or_str
```
## base64
```python
def t_b64():
    import base64
    def encode(raw):
        """
        äºŒè¿›åˆ¶æ•°æ®è¿›è¡ŒBase64ç¼–ç 

        å°†éASCIIå­—ç¬¦çš„æ•°æ®è½¬æ¢æˆASCIIå­—ç¬¦çš„ä¸€ç§æ–¹æ³• å¯¹æ•°æ®å†…å®¹è¿›è¡Œç¼–ç æ¥é€‚åˆä¼ è¾“ã€ä¿å­˜ï¼Œe.g asciiç æœ‰äº›å€¼ä¸å¯è§

        æ ¹è¯ä¹¦ï¼Œemailé™„ä»¶ Base64ç¼–ç å›¾ç‰‡
        """
        return base64.b64encode(to_bytes(raw))

    def decode(raw_b):
        return to_str(base64.b64decode(raw_b))

    encode_b = encode('fafafä¸ªæŠŠä¸ªå…³')
    print(encode_b)  # b'ZmFmYWbkuKrmiorkuKrlhbM='
    print(decode(encode_b))  # fafafä¸ªæŠŠä¸ªå…³
```

## hash
```python
def t_hmac():
    import hmac
    import hashlib

    def encode(secret_key, payload):
        """
        åŠ å¯†ç”¨çš„æ•£åˆ—å‡½æ•° 64ä½  md5ã€sha3 æ¶ˆæ¯æ— é™å¤§
        """
        # return hmac.new(to_bytes(secret_key), to_bytes(payload), digestmod=hashlib.sha256).digest()
        return hmac.new(to_bytes(secret_key), to_bytes(payload), digestmod=hashlib.sha256).hexdigest()

    signature = encode('21a1f34d2c785f296c90ba54ead31d98e5c1838351cdfea0434c9edfcd1a0252', 'woæˆ‘æ˜¯msg')
    print(signature)


def t_md5():
    import hashlib

    def encode(payload):
        """
        32 ä½ hashå‡½æ•°
        """
        # return hashlib.md5(to_bytes(payload)).digest()
        return hashlib.md5(to_bytes(payload)).hexdigest()

    print(encode('woæˆ‘æ˜¯msgfafafdfdfadfafafafafafa'))
```
[pycryptodome](https://github.com/Legrandin/pycryptodome)

## RSA
```python
def t_RSA(msg, passwd=None):
    from Crypto.PublicKey import RSA
    from Crypto.Cipher import PKCS1_v1_5 as Cipher_pkcs1_v1_5
    from Crypto.Signature import PKCS1_v1_5 as Signature_pkcs1_v1_5
    from Crypto.Hash import SHA256

    def generate(bits=2048, passwd=None, path='id_rsa', ):
        key = RSA.generate(bits)
        private_key = key.export_key(passphrase=passwd)

        with open(path + '.pub', "wb")as pub:
            pub.write(key.publickey().export_key())

        with open(path, "wb")as pub:
            pub.write(private_key)

    def encrypt(msg, passwd=None, path='id_rsa'):
        """å…¬é’¥åŠ å¯†"""
        msg = to_bytes(msg)
        key = RSA.import_key(open(path + '.pub').read(), passphrase=passwd)

        cipher = Cipher_pkcs1_v1_5.new(key)
        result = cipher.encrypt(msg)
        return result

    def decrypt(encrypt_txt, passwd=None, path='id_rsa'):
        key = RSA.import_key(open(path).read(), passphrase=passwd)

        cipher = Cipher_pkcs1_v1_5.new(key)
        result = cipher.decrypt(encrypt_txt, None)
        return result

    def sign(msg, passwd=None, path='id_rsa'):
        msg = to_bytes(msg)
        key = RSA.import_key(open(path).read(), passphrase=passwd)
        signer = Signature_pkcs1_v1_5.new(key)
        digest = SHA256.new(msg)
        signature = signer.sign(digest)
        return signature

    def check_sign(msg, sign, passwd=None, path='id_rsa'):
        msg = to_bytes(msg)
        key = RSA.import_key(open(path + '.pub').read(), passphrase=passwd)
        signer = Signature_pkcs1_v1_5.new(key)
        digest = SHA256.new(msg)
        assert signer.verify(digest, sign) is True

    generate(passwd=passwd)
    result = decrypt(encrypt(msg), passwd)
    assert msg == to_str(result)
    signature = sign(msg, passwd)
    check_sign(msg, signature)
```

## AES
```python
def t_AES(msg, passwd):
    from Crypto.Cipher import AES
    from Crypto import Random
    import hashlib
    import base64

    BS = AES.block_size
    """
    padå’Œunpadåˆ†åˆ«æ˜¯å¡«å……å‡½æ•°å’Œé€†å¡«å……å‡½æ•° 
    æ–‡æœ¬é•¿åº¦æ­£å¥½æ˜¯BlockSizeé•¿åº¦çš„å€æ•°ï¼Œä¹Ÿä¼šå¡«å……ä¸€ä¸ªBlockSizeé•¿åº¦çš„å€¼
    ç¼ºå‡ ä½å°±è¡¥å‡  è¦å¡«å……8ä¸ªå­—èŠ‚,é‚£ä¹ˆå¡«å……çš„å­—èŠ‚çš„å€¼å°±æ˜¯0x08
    
    AESåŠ å¯†å¯¹åŠ å¯†æ–‡æœ¬æœ‰é•¿åº¦è¦æ±‚
    å¿…é¡»æ˜¯AES.block_sizeçš„æ•´å€æ•°
    
    """
    pad = lambda s: s + (BS - len(s) % BS) * chr(BS - len(s) % BS)
    unpad = lambda s: s[:-ord(s[len(s) - 1:])]
    """
    å®é™…ä¸ŠAESåŠ å¯†æœ‰AES-128ã€AES-192ã€AES-256ä¸‰ç§ï¼Œ
    åˆ†åˆ«å¯¹åº”ä¸‰ç§å¯†é’¥é•¿åº¦128bitsï¼ˆ16å­—èŠ‚ï¼‰ã€192bitsï¼ˆ24å­—èŠ‚ï¼‰ã€256bitsï¼ˆ32å­—èŠ‚ï¼‰ã€‚
    å½“ç„¶ï¼Œå¯†é’¥è¶Šé•¿ï¼Œå®‰å…¨æ€§è¶Šé«˜ï¼ŒåŠ è§£å¯†èŠ±è´¹æ—¶é—´ä¹Ÿè¶Šé•¿ã€‚
    """
    passwd = hashlib.sha256(to_bytes(passwd)).digest()

    def encrypt(msg):
        msg = to_bytes(pad(msg))
        iv = Random.new().read(BS)
        cipher = AES.new(passwd, mode=AES.MODE_CBC, iv=iv)
        result = cipher.encrypt(msg)
        return base64.b64encode(iv + result)

    def decrypt(encrypt_txt):
        encrypt_txt = base64.b64decode(encrypt_txt)
        iv = encrypt_txt[:BS]
        cipher = AES.new(passwd, mode=AES.MODE_CBC, iv=iv)
        result = unpad(cipher.decrypt(encrypt_txt[BS:]))
        return result

    result = decrypt(encrypt(msg))
    assert msg == to_str(result)
```
---
layout:     post
rewards: false
title: Service Mesh
categories:
    - 系统架构
---

https://levelup.gitconnected.com/deciphering-the-difference-between-a-service-mesh-and-api-gateway-c57e4abec302

# what Service Mesh

服务网格是一个专用的基础设施层，它的目标是 “[在微服务架构中实现可靠、快速和安全的服务间调用](https://link.zhihu.com/?target=https%3A//buoyant.io/2017/04/25/whats-a-service-mesh-and-why-do-i-need-one/)”。

服务网格是一种工具，通过在平台层而不是应用程序层插入这些功能，为应用程序添加**可观察性、安全性和可靠性功能**。

服务网格通常被实现为与应用程序代码一起部署的一组可扩展的网络代理（这种模式有时称为**sidecar**）。这些**代理**处理微服务之间的通信，并充当可以引入服务网格功能的点。**代理包括服务网格的数据平面，并由其控制平面作为一个整体进行控制。**

**这些代理作为sidecar(边车)注入到每个服务部署中。服务不直接通过网络调用服务，而是调用它们的本地sidecar代理，后者代表服务管理请求，从而封装了服务间调用的复杂性。相互连接的sidecar代理实现了所谓的数据平面。**

服务网格的兴起与“云原生”应用程序的兴起息息相关。在云原生世界中，一个应用程序可能包含数百个服务；每个服务可能有数千个实例；并且这些实例中的每一个都可能处于不断变化的状态，因为它们是由 Kubernetes 等编排器动态调度的。在这个世界中，服务到服务的通信不仅极其复杂，而且还是应用程序运行时行为的基本部分。管理它对于确保端到端性能、可靠性和安全性至关重要。



# service mesh 结构功能

服务网格通常由两层实现：数据平面和控制平面。

- 数据平面

  充当连接的客户端和服务器端点的代理，执行从控制平面接收到的策略并将运行时指标报告给控制平面的监控工具。

- 控制平面

  管理数据平面的服务策略和编排。

![](https://tva1.sinaimg.cn/large/008i3skNgy1gsc3gx6b4zj30dw05rgli.jpg)

![img](https://tva1.sinaimg.cn/large/008i3skNgy1gsc6dbzq7zj312o0m6t9u.jpg)

基础功能

- Traffic Routing

  根据策略或配置将请求路由到服务实例，流量可能会被选择性地路由到不同版本的服务。

  - 金丝雀发布（Canary release）。
  - AB testing。
  - 服务版本控制/向后兼容性。

- 服务监控追踪

  proxy记录客户端和服务端调用的log，开发者不需要把打log的工作做到每个客户端和服务端。可以根据日志分析系统性能和可用性，可以追踪调用链

  - 服务图和仪表板显示服务如何相互连接（无需更改代码）。
  - 发出信号和警报，以显示延迟、吞吐量和错误率（无需更改代码）。
  - 跟踪请求或业务交易是如何通过网格的（只需在代码标头中更改传递交易 ID）。

- 弹性

  服务调用短暂无法使用，代理可以尝试使用该服务的备用路径或故障转移到备份服务。代理可以尝试使用该服务的备用路径或故障转移到备份服务。

  我们可以配置和实施的弹性模式示例：

  - 重试策略。
  - 断路器模式。
  - 速率限制、节流。

- 安全策略

  **将单体应用拆分为许多独立的服务会大大增加其攻击面。**每个服务都是需要保护的入口。使用服务网格，客户端和服务器端点上的代理都可以应用策略来保护两者之间的通信。代理负责身份验证、授权和加密，这就是服务网格内的零信任安全性。

- 身份识别

  **服务网格可以管理和维护哪些身份能访问哪些服务，并维护访客访问服务的日志。**身份可以通过 JWT 进行验证，从而允许基于终端用户以及服务调用进行授权。

- 加密

  如上所述，服务之间的通信是加密的。**控制平面提供证书管理功能**，例如证书生成和证书轮换，它会将这些证书和相关的配置数据推送到数据平面。

  相互 TLS 身份验证的支持非常强大。相互 TLS 是指两个端点把证书加入连接的另一端点白名单，它能提供身份验证和加密。

# why use/not service mesh

如果这些问题中的任何一个的答案是**“是”**，请评估服务网格的价值

- 网络拓扑是否会随着多个服务的扩展和缩减而频繁变化
- 代码变更频繁每周或者更频繁
- 10个或以上微服务，大量数据中心内的数据流量，会随时扩展5个或以上实例
- 安全：自动维护双向TLS
- 监控追踪服务间交互

什么情况下不使用

- 微服务小< 10，扩展实例小<5
- 不需要服务之间的细粒度跟踪。或者可观察性是您唯一的需要，也许可以使用 AppDynamics 等更简单的工具更轻松地解决。
- 几乎没有内部网络通信
- 固定网络拓扑
- 代码改动很少

几乎所有的服务网格都使用 Envoy side car 作为数据平面。**它们最明显的区别在于控制平面**。因此，对不同服务网格的评估应侧重于控制平面的特性以及哪些控制平面满足您的需求。

评估控制平面

- 控制平面是否在您的 Cl/CI 管道中提供最大价值
- 控制计划是否是配置形式的，最好不要手写script
- 操作容易，可以控制权限

# service mesh 和api 网关区别

微服务和 API 服务解决了两个不同的问题，前者是技术性问题，后者是业务问题。

- 微服务应在有界上下文（bounded context）中进行通信。它们的设计是由连接组成有界上下文的组件需求所驱动的，就像远程过程调用（RPC）一样。
- API（通常是 REST，但也包括事件流和其他协议，例如 SOAP、gRPC 和 GraphQL）应提供接口，将有界上下文暴露给外界。理想情况下，它们的接口设计是由业务价值驱动的，而不仅仅是 RPC。

换句话说，**API 是在外部将一个有界上下文的业务暴露给另一个有界上下文，而微服务是构成有界上下文内部的几个组件**。在传统体系结构中，这些组件可能是通过进程调用栈进行通信的类或 DLL。在微服务架构中，它们可能是跨网络通信的独立服务。



要了解服务网格和 API 网关之间的区别，首先我们要定义“定向流量”（directional traffic）。**东西流量通常是指数据中心内的数据，而南北方向是指进出数据中心的流量。**

在本文中，从有界上下文的角度来看：停留在有界上下文内的流量是东西流量，而越过有界上下文的流量是南北流量。

**服务网格旨在管理东西流量。**虽然 API 网关也可以管理东西流量，但服务网格更适合。这是因为服务网格在连接的两端都有代理。东西方都可以进行这种配置，因为这两个端点都由同一应用开发组织控制。

**服务网格同样可以管理南北流量，但 API 网关更适合**，因为它连接的一部分不在服务网格的控制范围之内。



此外，南北流量通常涉及业务合作伙伴，并且需要管理终端用户的体验。**API 网关更专注于管理终端用户体验。**它们通常是较大的 API 管理解决方案一部分，具有集成的 API 目录和开发人员门户，能将内部开发人员和外部业务合作伙伴加入其中。

相反，服务网格并不专注于管理服务客户端终端用户体验。由于**服务网格旨在管理组成应用程序、有界上下文的服务**，因此其所有的客户端通常由拥有服务的同一 IT 部门构建，团队可以轻松更改微服务的界面。

总而言之，**API 网关和服务网格两者是相辅相成的：API 网关处理外部流量和服务网格处理内部流量**，其拓扑结构如下图所示：

![图片](https://tva1.sinaimg.cn/large/008i3skNgy1gsc6a3ctkbj30dw0g50ud.jpg)

